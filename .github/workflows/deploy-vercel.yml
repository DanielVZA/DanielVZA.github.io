name: Deploy to Vercel

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout project
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Set Vercel Environment Variables
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          MONGOUSER: ${{secrets.MONGOUSER}}
          PASSWORD: ${{secrets.PASSWORD}}
          DBNAME: ${{secrets.DBNAME}}
          CLUSTER_APP_NAME: ${{secrets.CLUSTER_APP_NAME}}
          CLUSTER_URI: ${{secrets.CLUSTER_URI}}
        run: |
          echo "Injecting environment variables to project $PROJECT_ID Vercel..."
          curl -X PATCH "https://api.vercel.com/v9/projects/$PROJECT_ID/env" \
          -H "Authorization: Bearer $VERCEL_TOKEN" \
          -H "Content-Type: application/json" \
          -d '[
            {
              "key": "MONGOUSER",
              "value": "'"$MONGOUSER"'",
              "target": ["production"]
            },
            {
              "key": "PASSWORD",
              "value": "'"$PASSWORD"'",
              "target": ["production"]
            },
            {
              "key": "DBNAME",
              "value": "'"$DBNAME"'",
              "target": ["production"]
            },
            {
              "key": "CLUSTER_APP_NAME",
              "value": "'"$CLUSTER_APP_NAME"'",
              "target": ["production"]
            },
            {
              "key": "CLUSTER_URI",
              "value": "'"$CLUSTER_URI"'",
              "target": ["production"]
            },
          ]'

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          npm install -g vercel
          vercel pull --yes --environment=production --token "$VERCEL_TOKEN"
          vercel build --prod --token=$VERCEL_TOKEN
          vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
